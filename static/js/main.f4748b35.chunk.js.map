{"version":3,"sources":["dialer.ts","types.ts","RemoteSession.tsx","Presence.tsx","signaler.ts","Files.tsx","App.tsx","reportWebVitals.ts","index.tsx"],"names":["MessageReceivedEvent","sender","data","Event","AuthorizationRequestedEvent","filename","resolve","reject","ConnectionEvent","kind","ConnectionClosedEvent","ConnectionReadyEvent","Conn","signaler","id","remoteId","conn","chan","RTCPeerConnection","iceServers","urls","ondatachannel","event","channel","onerror","err","console","error","dispatchEvent","onclose","onopen","onmessage","msg","onicecandidate","candidate","signalCandidate","createDataChannel","this","createOffer","desc","setLocalDescription","debug","sendDescription","close","Promise","success","failure","readyState","removeEventListener","addEventListener","once","addIceCandidate","setRemoteDescription","createAnswer","answer","message","send","EventTarget","Dialer","registered","conns","register","removeConn","from","offer","push","to","informOffer","undefined","find","elt","confirmOffer","Error","filter","forEach","offerCallback","idx","findIndex","splice","all","map","establishedConn","c","init","Payload","chunkNumber","chunkTotalCount","metadata","value","end","chunkSize","encodeBlob","blob","reader","FileReader","onloadend","e","result","toString","readAsDataURL","RemoteSession","props","useState","setFilename","progress","setProgress","name","size","total","progressState","setProgressState","handleChange","files","a","length","file","useEffect","left","JSON","stringify","log","chunk","slice","state","dialer","dial","sessionId","ready","b64","className","htmlFor","friendlyName","toFixed","type","onChange","target","Presence","sessions","setSessions","ev","some","concat","session","sort","b","localeCompare","SessionEvent","SessionJoinedEvent","SessionLeftEvent","Signaler","mqtt","mqttPresencePrefix","fetch","connect","username","password","connectTimeout","clean","resubscribe","clientId","will","retain","payload","qos","topic","on","startsWith","tokens","split","input","parse","descriptionCallback","then","resp","publish","catch","warn","topics","subscribe","v","Files","receivedFiles","setReceivedFiles","fileTransfertRequests","setfileTransfertRequests","old","chunks","no","complete","reduce","acc","cur","requests","allow","deny","request","onClick","download","href","capitalizeFirstLetter","first","rest","locale","navigator","language","toLocaleUpperCase","join","pick","array","Math","floor","random","Array","adjectives","names","App","reportWebVitals","onPerfEntry","Function","getCLS","getFID","getFCP","getLCP","getTTFB","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"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","file":"static/js/main.f4748b35.chunk.js","sourcesContent":["import Signaler, { SessionLeftEvent } from \"./signaler\";\nimport { Offer } from './types';\n\nexport class MessageReceivedEvent extends Event {\n  constructor(public sender: string, public data: string) {\n    super(\"message_received\");\n  }\n}\n\nexport class AuthorizationRequestedEvent extends Event {\n  constructor(public sender: string, public filename: string, public resolve: Function, public reject: Function) {\n    super(\"authorization_requested\");\n  }\n}\n\nexport class ConnectionEvent extends Event {\n  constructor(kind: string) {\n    super(`connection_${kind}`)\n  }\n}\n\nexport class ConnectionClosedEvent extends ConnectionEvent {\n  constructor() {\n    super('closed');\n  }\n}\nexport class ConnectionReadyEvent extends ConnectionEvent {\n  constructor() {\n    super('ready');\n  }\n}\n\n\nexport class Conn extends EventTarget {\n  private conn: RTCPeerConnection;\n  private chan: RTCDataChannel;\n  constructor(private signaler: Signaler, private id: string, private remoteId: string, public filename: string) {\n    super();\n    this.signaler = signaler;\n    this.id = id;\n    this.filename = filename;\n    this.remoteId = remoteId;\n    const defaults = {\n      config: {\n        iceServers: [\n          { urls: \"stun:stun.l.google.com:19302\" },\n        ]\n      },\n      debug: 3,\n    };\n    this.conn = new RTCPeerConnection(defaults.config);\n    this.conn.ondatachannel = (event) => {\n      event.channel.onerror = (err) => {\n        console.error(err)\n        this.dispatchEvent(new ConnectionClosedEvent())\n      }\n      event.channel.onclose = (err) => {\n        this.dispatchEvent(new ConnectionClosedEvent())\n      }\n      event.channel.onopen = () => {\n        this.dispatchEvent(new ConnectionReadyEvent())\n      };\n      event.channel.onmessage = (msg) => {\n        this.dispatchEvent(new MessageReceivedEvent(this.remoteId, msg.data));\n      };\n    };\n    this.conn.onicecandidate = (event) => {\n      if (event.candidate) {\n        this.signaler.signalCandidate(this.remoteId, event.candidate);\n      }\n    };\n    this.chan = this.conn.createDataChannel(`io.pushr.channels.send.${id}-${remoteId}`);\n\n  }\n  async init() {\n    const desc = await this.conn.createOffer();\n    this.conn.setLocalDescription(desc);\n    console.debug(this.remoteId, 'sending description')\n    return this.signaler.sendDescription(this.remoteId, desc, this.filename);\n  }\n  close() {\n    this.chan.close();\n    this.conn.close()\n  }\n  async ready(): Promise<void> {\n    return new Promise((resolve, reject) => {\n      if (this.chan.readyState === \"open\") {\n        resolve();\n        return\n      }\n      let success: EventListener, failure: EventListener;\n\n      success = () => { this.removeEventListener('connection_closed', failure); resolve() };\n      failure = () => { this.removeEventListener('connection_ready', success); reject() };\n\n      console.debug('waiting for conn to be ready. current state is', this.chan.readyState)\n      this.addEventListener('connection_ready', success, { once: true });\n      this.addEventListener('connection_closed', failure, { once: true });\n\n    });\n  }\n  async addIceCandidate(candidate: RTCIceCandidate | RTCIceCandidateInit) {\n    if (candidate !== null) {\n      console.debug(this.remoteId, 'received ice candidate', candidate)\n      try {\n        await this.conn.addIceCandidate(candidate);\n      } catch (err) {\n        console.error(\"failed to add remote ICE candidate:\", err)\n      }\n    }\n  }\n  async informOffer(desc: RTCSessionDescriptionInit) {\n    console.debug(this.remoteId, 'received remote description', desc)\n    this.conn.setRemoteDescription(desc);\n    const answer = await this.conn.createAnswer();\n    this.conn.setLocalDescription(answer);\n    console.debug(this.remoteId, 'description exchange complete')\n    return answer;\n  }\n  offerCallback(desc: RTCSessionDescriptionInit) {\n    this.conn.setRemoteDescription(desc);\n    console.debug(this.remoteId, 'description exchange complete')\n  }\n  send(message: string) {\n    return this.chan.send(message);\n  }\n}\n\ninterface establishedConn {\n  to: string;\n  from: string;\n  conn: Conn;\n}\n\nexport class Dialer extends EventTarget {\n  private registered = false;\n  private conns: establishedConn[];\n\n  constructor(private signaler: Signaler, private id: string) {\n    super();\n    this.signaler = signaler;\n    this.conns = [];\n    this.id = id;\n  }\n  register() {\n    this.signaler.register(this);\n    this.signaler.addEventListener('session_left', ((event: SessionLeftEvent) => {\n      this.removeConn(event.id);\n    }) as EventListener)\n    this.registered = true;\n  }\n  async confirmOffer(from: string, offer: Offer) {\n    const conn = new Conn(this.signaler, this.id, from, offer.filename);\n    conn.addEventListener('connection_closed', (() => {\n      this.removeConn(from);\n    }) as EventListener);\n\n    conn.addEventListener(\"message_received\", ((event: MessageReceivedEvent) => {\n      this.dispatchEvent(new MessageReceivedEvent(event.sender, event.data))\n    }) as EventListener);\n\n    this.conns.push({ from: from, to: this.id, conn: conn });\n    return conn.informOffer(offer.desc);\n  }\n  async informOffer(from: string, offer: Offer) {\n    let establishedConn = this.conns.find(elt => elt.from === from && elt.conn.filename === offer.filename);\n    if (establishedConn !== undefined) { return }\n    try {\n      await new Promise((resolve, reject) => {\n        this.dispatchEvent(new AuthorizationRequestedEvent(from, offer.filename, resolve, reject));\n      })\n      return this.confirmOffer(from, offer);\n    } catch {\n      throw new Error('permission denied')\n    }\n  }\n  descriptionCallback(from: string, desc: RTCSessionDescriptionInit) {\n    this.conns\n      .filter((elt) => elt.to === from)\n      .forEach((elt) => {\n        elt.conn.offerCallback(desc);\n      });\n  }\n  removeConn(to: string) {\n    let idx = this.conns.findIndex(elt => elt.to === to);\n    if (idx < 0) { return }\n    this.conns[idx].conn.close();\n    this.conns.splice(idx, 1);\n\n    idx = this.conns.findIndex(elt => elt.from === to);\n    if (idx < 0) { return }\n    this.conns[idx].conn.close();\n    this.conns.splice(idx, 1);\n\n    console.debug(`removed connection to ${to}`)\n  }\n  async addIceCandidate(from: string, candidate: RTCIceCandidate | RTCIceCandidateInit) {\n    return Promise.all(this.conns\n      .filter((elt) => elt.to === from)\n      .map(elt => elt.conn.addIceCandidate(candidate)));\n  }\n  async dial(remoteId: string, filename: string) {\n    if (!this.registered) {\n      throw new Error(\"dialer not registered\")\n    }\n    let establishedConn = this.conns.find(elt => elt.to === remoteId && elt.conn.filename === filename);\n    if (establishedConn !== undefined) { return establishedConn.conn }\n    console.debug('conn to', remoteId, 'not found: dialing a new one')\n    const c = new Conn(this.signaler, this.id, remoteId, filename);\n    this.conns.push({ from: this.id, to: remoteId, conn: c });\n    c.addEventListener('connection_closed', (() => {\n      this.removeConn(remoteId);\n    }) as EventListener);\n    await c.init();\n    console.debug(remoteId, 'conn init done')\n    return c;\n  }\n}\n","export class Payload {\n  constructor(\n    public chunkNumber: number,\n    public chunkTotalCount: number,\n    public metadata: Metadata,\n    public value: string,\n    public end: boolean,\n  ) { }\n}\n\nexport interface Offer {\n  desc: RTCSessionDescriptionInit;\n  filename: string\n};\n\nexport interface Metadata {\n  name: string;\n  size: number;\n}\n","import React, { useEffect, useState } from \"react\";\nimport { Conn, Dialer, } from \"./dialer\";\nimport { Metadata, Payload } from \"./types\";\nimport Signaler from './signaler';\n\nexport interface RemoteSessionProps {\n  sessionId: string;\n  friendlyName: string;\n  dialer: Dialer;\n  signaler: Signaler;\n}\n\n\nconst chunkSize = 1000;\ninterface progressState {\n  conn?: Conn;\n  value: string;\n  metadata: Metadata;\n  chunkNumber: number;\n  total: number;\n}\n\n\nconst percentage = (total: number, left: number): number =>\n  total === 0 ? 100 : (((total - left) / total) * 100);\n\nconst encodeBlob = (blob: Blob): Promise<string> => {\n  return new Promise((resolve) => {\n    const reader = new FileReader();\n    reader.onloadend = function (e) {\n      if (reader.result) {\n        resolve(reader.result.toString());\n      }\n    };\n    reader.readAsDataURL(blob);\n  });\n};\n\n\nexport const RemoteSession = (props: RemoteSessionProps) => {\n  const [filename, setFilename] = useState<string>(\"\");\n  const [progress, setProgress] = useState(0);\n  const [progressState, setProgressState] = useState<progressState>({\n    chunkNumber: 0,\n    conn: undefined,\n    metadata: { name: \"\", size: 0 },\n    total: 0,\n    value: \"\",\n  });\n\n\n  const handleSubmit = (e: React.ChangeEvent<HTMLInputElement>) => {\n    handleChange(e.target.files);\n  };\n\n\n  const handleChange = async (files: FileList | null) => {\n    if (files === null || files.length === 0) {\n      setFilename(\"\");\n      setProgress(0);\n      return;\n    }\n    const file = files[0];\n    setFilename(file.name);\n    await send({ name: file.name, size: file.size }, file);\n  };\n  useEffect(() => {\n    if (!progressState.conn) { return }\n    setProgress(percentage(progressState.total, progressState.value.length));\n    if (progressState.value.length === 0) {\n      progressState.conn.send(\n        JSON.stringify(\n          new Payload(\n            progressState.chunkNumber,\n            progressState.total / chunkSize,\n            progressState.metadata,\n            \"\",\n            true\n          )\n        )\n      );\n      console.log(\"send complete\");\n      progressState.conn.close()\n      return;\n    }\n    const chunk = progressState.value.slice(0, chunkSize);\n    progressState.conn.send(\n      JSON.stringify(\n        new Payload(\n          progressState.chunkNumber,\n          progressState.total / chunkSize,\n          progressState.metadata,\n          chunk,\n          false\n        )\n      )\n    );\n    setProgressState((state) => ({\n      chunkNumber: state.chunkNumber + 1,\n      conn: state.conn,\n      metadata: state.metadata,\n      value: state.value.slice(chunk.length),\n      total: state.total,\n    }));\n  }, [progressState]);\n\n  const send = async (metadata: Metadata, data: Blob) => {\n    const conn = await props.dialer.dial(props.sessionId, metadata.name);\n    await conn.ready();\n    const b64 = await encodeBlob(data);\n    setProgressState({\n      chunkNumber: 0,\n      conn: conn,\n      metadata: metadata,\n      value: b64,\n      total: b64.length,\n    });\n  };\n\n\n\n  return (\n    <button className=\"sessionIcon\"    >\n      <label htmlFor={props.sessionId}>\n        {props.friendlyName}\n        {filename !== \"\" && progress < 100 ? (\n          <div>\n            {filename} ({progress.toFixed(2)}%)\n          </div>\n        ) : null}\n        <input\n          type=\"file\"\n          className=\"remote-session-input\"\n          id={props.sessionId}\n          onChange={handleSubmit}\n        />\n      </label>\n    </button>\n  );\n};\n","import { useEffect, useState } from \"react\";\nimport { Dialer } from \"./dialer\";\nimport { RemoteSession } from \"./RemoteSession\";\nimport Signaler, { SessionJoinedEvent, SessionLeftEvent } from \"./signaler\";\n\nexport interface PresenceProps {\n  id: string;\n  friendlyName: string;\n  dialer: Dialer;\n  signaler: Signaler;\n}\ninterface session {\n  id: string;\n  friendlyName: string;\n}\nexport const Presence = (props: PresenceProps) => {\n  const [sessions, setSessions] = useState<session[]>([]);\n  useEffect(() => {\n    props.signaler.addEventListener(\"session_joined\", ((\n      ev: SessionJoinedEvent\n    ) => {\n      console.debug(\"session\", ev.id, \"joined\");\n      setSessions((sessions) => {\n        if (!sessions.some((elt) => elt.id === ev.id)) {\n          return sessions.concat({ id: ev.id, friendlyName: ev.friendlyName });\n        }\n        return sessions;\n      });\n    }) as EventListener);\n\n    props.signaler.addEventListener(\"session_left\", ((ev: SessionLeftEvent) => {\n      console.debug(\"session\", ev.id, \"left\");\n      setSessions((sessions) => sessions.filter((elt) => elt.id !== ev.id));\n    }) as EventListener);\n  }, [props]);\n\n  return (\n    <div>\n      <div>Peers</div>\n      <div className=\"grid\">\n        {sessions\n          .filter((session) => session.id !== props.id)\n          .sort((a, b) => a.friendlyName.localeCompare(b.friendlyName))\n          .map((session) => (\n            <div className=\"block\" key={session.id}>\n              <RemoteSession\n                dialer={props.dialer}\n                signaler={props.signaler}\n                sessionId={session.id}\n                friendlyName={session.friendlyName}\n              />\n            </div>\n          ))}\n      </div>\n    </div>\n  );\n};\n","import mqtt from \"mqtt\";\n\nconst qosLevel = 2;\n\nexport class SessionEvent extends Event {\n  id: string;\n  constructor(kind: string, id: string) {\n    super(`session_${kind}`);\n    this.id = id;\n  }\n}\n\nexport class SessionJoinedEvent extends SessionEvent {\n  friendlyName: string;\n  constructor(id: string, friendlyName: string) {\n    super(\"joined\", id);\n    this.friendlyName = friendlyName;\n  }\n}\nexport class SessionLeftEvent extends SessionEvent {\n  constructor(id: string) {\n    super(\"left\", id);\n  }\n}\n\ninterface session {\n  id: string;\n  name: string;\n}\n\nconst brokerURL = 'wss://broker.iot.cloud.vx-labs.net/mqtt';\n//const brokerURL = 'ws://localhost:8080/mqtt';\n\nexport default class Signaler extends EventTarget {\n  private dialer: any;\n  private mqtt: mqtt.MqttClient;\n  private sessions: session[] = [];\n\n  close() {\n    this.mqtt.end(true);\n  }\n  getPeer(id: string): session {\n    const v = this.sessions.find(elt => elt.id === id)\n    if (v === undefined) { return { id: id, name: ' Unknown' } }\n    return v;\n  }\n  constructor(private id: string, private name: string) {\n    super();\n    const mqttPresencePrefix = `sessions/`;\n    // chrome refuses to connect without this, I do not understand why.\n    try { fetch('https://broker.iot.cloud.vx-labs.net/mqtt') } catch { }\n    this.mqtt = mqtt.connect(brokerURL, {\n      username: \"julien@bonachera.fr/pushr/browser\",\n      password: \"VeryPasswordMuchSecureWow\",\n      connectTimeout: 30 * 1000,\n      clean: true,\n      resubscribe: false,\n      clientId: `pushr_${id}`,\n      will: {\n        retain: true,\n        payload: '',\n        qos: qosLevel,\n        topic: `sessions/${this.id}`,\n      },\n    });\n    this.mqtt.on(\"message\", (topic, payload) => {\n      //console.debug(`${topic} -> ${payload.toString()}`);\n      if (topic.startsWith(mqttPresencePrefix)) {\n        topic = topic.slice(mqttPresencePrefix.length);\n        const tokens = topic.split(\"/\");\n        if (tokens.length === 1) {\n          const sessionId = tokens[0];\n          if (payload.length === 0) {\n            if (this.sessions.some(elt => elt.id === sessionId)) {\n              this.sessions = this.sessions.filter(elt => elt.id !== sessionId)\n            }\n            this.dispatchEvent(new SessionLeftEvent(sessionId));\n          } else {\n            const input = JSON.parse(payload.toString())\n            if (!this.sessions.some(elt => elt.id === sessionId)) {\n              this.sessions.push({ id: sessionId, name: input.name })\n            }\n            this.dispatchEvent(new SessionJoinedEvent(sessionId, input.name));\n          }\n        } else if (topic.startsWith(this.id)) {\n          // RPC\n          if (this.dialer === undefined) {\n            console.error('dropped packet: dialer not registered')\n            return;\n          }\n          topic = topic.slice(this.id.length + 1);\n          switch (topic) {\n            case \"candidate\":\n              {\n                const msg = JSON.parse(payload.toString());\n                this.dialer.addIceCandidate(msg.from, msg.candidate);\n              }\n              break;\n            case \"description_denied\":\n              {\n                const msg = JSON.parse(payload.toString());\n                this.dialer.removeConn(msg.from);\n              }\n              break;\n            case \"description_answer\":\n              {\n                const msg = JSON.parse(payload.toString());\n                this.dialer.descriptionCallback(msg.from, msg.desc);\n              }\n              break;\n            case \"description\":\n              {\n                const msg = JSON.parse(payload.toString());\n                this.dialer\n                  .informOffer(msg.from, { desc: msg.desc, filename: msg.filename })\n                  .then((resp: any) => {\n                    this.mqtt.publish(\n                      `sessions/${msg.from}/description_answer`,\n                      JSON.stringify({ from: this.id, desc: resp }),\n                      { qos: qosLevel }\n                    );\n                  })\n                  .catch(() => {\n                    this.mqtt.publish(\n                      `sessions/${msg.from}/description_denied`,\n                      JSON.stringify({ from: this.id, }),\n                      { qos: qosLevel }\n                    );\n                  });\n              }\n              break;\n            default:\n              console.warn(\"unknown rpc received:\", topic);\n          }\n        }\n      }\n    });\n    this.mqtt.on(\"connect\", async () => {\n      const topics = [\n        `sessions/${this.id}/+`,\n        `sessions/+`\n      ]\n\n      this.mqtt.subscribe(topics, { qos: qosLevel }, (err) => {\n        if (err) {\n          console.error(\"presence setup failed\", err)\n          return\n        }\n        console.log('presence setup')\n        this.mqtt.publish(`sessions/${this.id}`, JSON.stringify({ id: this.id, name: this.name }), {\n          qos: qosLevel,\n          retain: true,\n        }, (err) => {\n          if (err) {\n            console.error(err)\n          }\n        });\n      });\n      console.debug('connection to mqtt broker established')\n    });\n  }\n\n  register(dialer: any) {\n    this.dialer = dialer;\n  }\n\n  async signalCandidate(to: string, candidate: any): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.mqtt.publish(\n        `sessions/${to}/candidate`,\n        JSON.stringify({\n          candidate,\n          from: this.id,\n        }),\n        { qos: qosLevel },\n        (err) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve();\n          }\n        }\n      );\n    });\n  }\n  async sendDescription(to: string, desc: RTCSessionDescriptionInit, filename: string): Promise<void> {\n    return new Promise((resolve, reject) => {\n      this.mqtt.publish(\n        `sessions/${to}/description`,\n        JSON.stringify({ from: this.id, desc: desc, filename: filename }),\n        { qos: qosLevel },\n        (err) => {\n          if (err) {\n            reject(err);\n          } else {\n            resolve();\n          }\n        }\n      );\n    });\n  }\n}\n","import { useEffect, useState } from \"react\";\nimport { AuthorizationRequestedEvent, Dialer, MessageReceivedEvent } from \"./dialer\";\nimport { Payload } from \"./types\";\n\nexport interface FileProps {\n  dialer: Dialer;\n}\n\ninterface receivedFile {\n  name: string;\n  from: string;\n  size: number;\n  value: string;\n  chunkTotalCount: number;\n  chunks: { no: number; value: string }[];\n  complete: boolean;\n}\n\ninterface fileTransfertRequest {\n  filename: string;\n  allow?: () => void;\n  deny?: () => void;\n}\n\nconst percentage = (total: number, left: number): number =>\n  total === 0 ? 100 : (((total - left) / total) * 100);\n\nexport const Files = (props: FileProps) => {\n  const [receivedFiles, setReceivedFiles] = useState<receivedFile[]>([]);\n  const [fileTransfertRequests, setfileTransfertRequests] = useState<fileTransfertRequest[]>([]);\n\n  useEffect(() => {\n    props.dialer.addEventListener(\"message_received\", ((\n      ev: MessageReceivedEvent\n    ) => {\n      try {\n        const payload = JSON.parse(ev.data) as Payload;\n\n        setReceivedFiles((state: receivedFile[]) => {\n          const files = state.slice();\n          const old = files.find(\n            (elt) =>\n              elt.from === ev.sender && elt.name === payload.metadata.name\n          );\n          if (old !== undefined) {\n            if (old.chunkTotalCount === 0) {\n              old.chunkTotalCount = payload.chunkTotalCount;\n              old.chunks = [{ no: payload.chunkNumber, value: payload.value }];\n              old.size = payload.metadata.size;\n            } else {\n              if (payload.end) {\n                old.value = old.chunks\n                  .sort((a, b) => a.no - b.no)\n                  .reduce((acc, cur) => acc + cur.value, \"\");\n                old.complete = true;\n              } else {\n                if (!old.chunks.some((elt) => elt.no === payload.chunkNumber)) {\n                  old.chunks = old.chunks.concat({\n                    no: payload.chunkNumber,\n                    value: payload.value,\n                  });\n                }\n              }\n            }\n          } else {\n            return files.concat({\n              from: ev.sender,\n              chunkTotalCount: payload.chunkTotalCount,\n              chunks: [{ no: payload.chunkNumber, value: payload.value }],\n              value: \"\",\n              size: payload.metadata.size,\n              name: payload.metadata.name,\n              complete: false,\n            });\n          }\n          return files;\n        });\n      } catch (err) {\n        console.log(\"failed:\", err);\n      }\n    }) as EventListener);\n  }, [props]);\n\n\n  useEffect(() => {\n    props.dialer.addEventListener(\"authorization_requested\", ((\n      ev: AuthorizationRequestedEvent\n    ) => {\n      setfileTransfertRequests((requests) => {\n        if (requests.some((elt) => elt.filename === ev.filename)) { return requests }\n        return requests.concat({\n          filename: ev.filename,\n          allow: () => {\n            setReceivedFiles((files) => files.concat({\n              from: ev.sender,\n              chunkTotalCount: 0,\n              chunks: [],\n              complete: false,\n              value: \"\",\n              name: ev.filename,\n              size: 0,\n            }))\n            setfileTransfertRequests([]);\n            ev.resolve()\n          },\n          deny: () => {\n            setfileTransfertRequests([]);\n            ev.reject();\n          },\n        })\n      })\n    }) as EventListener);\n  }, [props]);\n\n\n\n  const authorization = (requests: fileTransfertRequest[]) =>\n    requests.map((request) =>\n    (<li key={request.filename}>\n      {request.filename}\n      <button onClick={request.allow}>Accept</button>\n      <button onClick={request.deny}>Refuse</button>\n    </li>)\n    );\n\n\n\n  return (\n    <div>\n      <div>Received Files</div>\n      <div>\n        <ul className=\"receivedFiles blockContent\">\n          {authorization(fileTransfertRequests)}\n          {receivedFiles\n            .filter((elt) => !elt.complete)\n            .map((elt) => (\n              <li key={elt.from + elt.name}>\n                {elt.name} ({(100 - percentage(elt.chunkTotalCount, elt.chunks.length)).toFixed(2)}%)\n              </li>\n            ))}\n          {receivedFiles\n            .filter((elt) => elt.complete)\n            .map((elt) => (\n              <li key={elt.from + elt.name}>\n                <a download={elt.name} href={elt.value}>\n                  {elt.name}\n                </a>\n              </li>\n            ))}\n        </ul>\n      </div>\n    </div>\n  );\n};\n","import React from \"react\";\nimport \"./App.css\";\nimport names from \"./assets/names.json\";\nimport adjectives from \"./assets/adjectives.json\";\nimport { Dialer } from \"./dialer\";\nimport { Presence } from \"./Presence\";\nimport Signaler from \"./signaler\";\nimport { Files } from './Files';\n\n\nconst getID = (): string => {\n  return [...Array(8)]\n    .map(() => (~~(Math.random() * 36)).toString(36))\n    .join(\"\");\n};\n\n\nconst capitalizeFirstLetter = (\n  [first, ...rest]: string,\n  locale = navigator.language\n) => {\n  return [first.toLocaleUpperCase(locale), ...rest].join(\"\");\n};\n\nconst pick = (array: string[]): string => {\n  return array[Math.floor(Math.random() * array.length)];\n};\n\nconst getName = (): string => {\n  return `${capitalizeFirstLetter(pick(adjectives))} ${capitalizeFirstLetter(\n    pick(names)\n  )}`;\n};\n\nconst id = getID();\nconst name = getName();\n\nconst signaler = new Signaler(id, name);\n\nconst dialer = new Dialer(signaler, id);\ndialer.register();\n\nfunction App() {\n  return (\n    <div className=\"App\">\n      <div className='grid'>\n        <div className=\"peers block\">\n          <Presence\n            dialer={dialer}\n            friendlyName={name}\n            signaler={signaler}\n            id={id}\n          />\n        </div>\n        <div className=\"block\">\n          <Files dialer={dialer} />\n        </div>\n      </div>\n      <div className=\"self\">\n        <div>I am {name}</div>\n      </div>\n    </div>\n  );\n}\n\nexport default App;\n","import { ReportHandler } from 'web-vitals';\n\nconst reportWebVitals = (onPerfEntry?: ReportHandler) => {\n  if (onPerfEntry && onPerfEntry instanceof Function) {\n    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {\n      getCLS(onPerfEntry);\n      getFID(onPerfEntry);\n      getFCP(onPerfEntry);\n      getLCP(onPerfEntry);\n      getTTFB(onPerfEntry);\n    });\n  }\n};\n\nexport default reportWebVitals;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport reportWebVitals from './reportWebVitals';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n\n// If you want to start measuring performance in your app, pass a function\n// to log results (for example: reportWebVitals(console.log))\n// or send to an analytics endpoint. Learn more: https://bit.ly/CRA-vitals\nreportWebVitals();\n"],"sourceRoot":""}